<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Smart Campus Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind via CDN (fine for MVP; switch to build step later) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  </head>
  <body class="bg-slate-900 text-slate-100">
    <div id="root" class="min-h-screen flex items-center justify-center"></div>

    <script type="text/javascript">
      const { useState, useEffect, useRef } = React;

      function ChatMessage({ message }) {
        const isUser = message.role === "user";
        return React.createElement(
          "div",
          {
            className:
              "flex mb-3 " + (isUser ? "justify-end" : "justify-start"),
          },
          React.createElement(
            "div",
            {
              className:
                "max-w-[80%] rounded-2xl px-4 py-2 shadow " +
                (isUser
                  ? "bg-blue-600 text-white rounded-br-sm"
                  : "bg-slate-800 text-slate-50 rounded-bl-sm"),
            },
            React.createElement(
              "div",
              {
                className:
                  "text-[11px] uppercase tracking-wide mb-1 opacity-60",
              },
              isUser ? "You" : "Assistant"
            ),
            React.createElement("div", { className: "text-sm whitespace-pre-wrap leading-relaxed" }, message.content)
          )
        );
      }

      function QuickActions({ onSelect }) {
        const actions = [
          { label: "Today’s timetable", value: "What is my timetable for today?" },
          { label: "Bus timings", value: "Show me the campus bus schedule." },
          { label: "Upcoming events", value: "What events are happening this week?" },
          { label: "Exam notifications", value: "Show upcoming exam schedule." },
        ];

        return React.createElement(
          "div",
          { className: "flex flex-wrap gap-2 mb-3" },
          actions.map((a) =>
            React.createElement(
              "button",
              {
                key: a.label,
                onClick: () => onSelect(a.value),
                className:
                  "text-xs px-3 py-1 rounded-full border border-slate-600/70 bg-slate-800/70 hover:bg-slate-700/80 transition-colors",
              },
              a.label
            )
          )
        );
      }

      function App() {
        const [messages, setMessages] = useState([
          {
            role: "assistant",
            content:
              "Hi! I’m your Smart Campus Assistant. Ask me about timetables, bus schedules, events, exams, or faculty.",
          },
        ]);
        const [input, setInput] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const listRef = useRef(null);

        useEffect(() => {
          if (listRef.current) {
            listRef.current.scrollTop = listRef.current.scrollHeight;
          }
        }, [messages, loading]);

        async function sendMessage(text) {
          if (!text.trim() || loading) return;
          setError(null);
          const userMessage = { role: "user", content: text.trim() };
          setMessages((prev) => [...prev, userMessage]);
          setInput("");
          setLoading(true);

          try {
            const res = await fetch("http://localhost:8000/api/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message: text.trim() }),
            });

            if (!res.ok) {
              const errorText = await res.text();
              console.error("API error:", res.status, errorText);
              throw new Error(`API error (${res.status}): ${errorText.substring(0, 100)}`);
            }

            const data = await res.json();
            let enrichedAnswer = data.answer || "";

            function tableFromArray(title, rows, columns) {
              if (!rows || !rows.length) return "";
              let out = "\\n\\n" + title + "\\n";
              out += columns.join(" | ") + "\\n";
              out += "-".repeat(columns.join(" | ").length) + "\\n";
              rows.forEach((r) => {
                out +=
                  columns
                    .map((c) => String(r[c] ?? ""))
                    .join(" | ") + "\\n";
              });
              return out;
            }

            if (data.timetable && data.timetable.length) {
              enrichedAnswer += tableFromArray("Timetable", data.timetable, [
                "day_of_week",
                "start_time",
                "end_time",
                "course_code",
                "room",
              ]);
            }
            if (data.bus_routes && data.bus_routes.length) {
              enrichedAnswer += tableFromArray("Bus Routes", data.bus_routes, [
                "route_name",
                "origin",
                "destination",
                "departure_time",
              ]);
            }
            if (data.events && data.events.length) {
              enrichedAnswer += tableFromArray("Events", data.events, [
                "title",
                "start_date",
                "location",
              ]);
            }

            const assistantMessage = {
              role: "assistant",
              content: enrichedAnswer,
            };
            setMessages((prev) => [...prev, assistantMessage]);
          } catch (e) {
            console.error("Chat error:", e);
            setError(
              e.message || "Could not reach backend. Is it running on port 8000? Check console for details."
            );
          } finally {
            setLoading(false);
          }
        }

        function handleSubmit(e) {
          e.preventDefault();
          sendMessage(input);
        }

        return React.createElement(
          "div",
          {
            className:
              "w-full max-w-3xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex flex-col h-screen",
          },
          React.createElement(
            "header",
            { className: "mb-4" },
            React.createElement(
              "h1",
              { className: "text-xl font-semibold text-white" },
              "Smart Campus Assistant"
            ),
            React.createElement(
              "p",
              { className: "text-xs text-slate-400 mt-1" },
              "Ask about timetables, exams, bus schedules, events, faculty, and FAQs in one place."
            )
          ),
          React.createElement(
            "main",
            {
              className:
                "flex-1 flex flex-col bg-slate-900/40 border border-slate-700/60 rounded-2xl overflow-hidden backdrop-blur",
            },
            React.createElement(
              "div",
              { className: "p-4 border-b border-slate-800/80" },
              React.createElement(QuickActions, {
                onSelect: (v) => sendMessage(v),
              })
            ),
            React.createElement(
              "div",
              {
                ref: listRef,
                className:
                  "flex-1 overflow-y-auto px-4 py-3 space-y-1 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900",
              },
              messages.map((m, i) =>
                React.createElement(ChatMessage, { key: i, message: m })
              ),
              loading &&
                React.createElement(
                  "div",
                  { className: "text-xs text-slate-400 mt-2" },
                  "Thinking…"
                )
            ),
            error &&
              React.createElement(
                "div",
                {
                  className:
                    "px-4 pb-2 text-xs text-red-400 bg-red-950/40 border-t border-red-900/40",
                },
                error
              ),
            React.createElement(
              "form",
              {
                onSubmit: handleSubmit,
                className:
                  "p-3 border-t border-slate-800 flex items-center gap-2 bg-slate-950/60",
              },
              React.createElement("input", {
                type: "text",
                value: input,
                onChange: (e) => setInput(e.target.value),
                placeholder:
                  "Ask me anything about your campus: \"When is my next class?\"",
                className:
                  "flex-1 bg-slate-900/80 border border-slate-700/80 rounded-full px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70 focus:border-blue-500/70",
              }),
              React.createElement(
                "button",
                {
                  type: "submit",
                  disabled: loading,
                  className:
                    "inline-flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium bg-blue-600 hover:bg-blue-500 disabled:opacity-60 disabled:cursor-not-allowed transition-colors",
                },
                "Send"
              )
            )
          )
        );
      }

      // React 18 createRoot with fallback for compatibility
      const rootElement = document.getElementById("root");
      if (ReactDOM.createRoot) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(React.createElement(App));
      } else {
        // Fallback for older React versions
        ReactDOM.render(React.createElement(App), rootElement);
      }
      
      // Test backend connectivity on load
      fetch("http://localhost:8000/api/health")
        .then((res) => res.json())
        .then((data) => console.log("Backend health check:", data))
        .catch((err) => console.error("Backend not reachable:", err));
    </script>
  </body>
</html>



